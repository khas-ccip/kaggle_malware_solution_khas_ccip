import pickle as pkl
import json
import pandas as pd
import xgboost as xgb
import numpy as np

# To read directory structure from SETTINGS.json file
with open('./../SETTINGS.json', 'r') as f:
	settings = json.load(f)

with open('.' + settings['MODEL_CHECKPOINT_DIR'] + 'best_xgb_model.pkl', 'rb') as f:
	gbm_model = pkl.load(f)
	
test_file_name = '.' + settings['TEST_DATA_FINAL_PATH']
original_test_df = pd.read_csv(test_file_name, low_memory=False)
original_test_df['HasDetections'] = np.zeros(len(original_test_df)) # Add an empty column for predicitons
original_testset = xgb.DMatrix(original_test_df.drop(["MachineIdentifier", "HasDetections"], axis=1).values)

predictions = gbm_model.predict(original_testset, ntree_limit=gbm_model.best_iteration + 1) # get predictions

original_test_df['HasDetections'] = predictions
submission_df = original_test_df[["MachineIdentifier", "HasDetections"]] # create submission dataframe

filename = 'submission.csv.zip'
submission_df.to_csv('.' + settings['SUBMISSION_DIR'] + filename, index=False, compression='zip') # write submission file
